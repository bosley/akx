(io/putf "=== Forms Affordance Invocation Tests ===\n")

(io/putf "Test 1: Invoke affordance on int value\n")
(form-define :Counter :int)
(form-add-affordance :Counter :increment (lambda [x] (+ x 1)))
(let counter 10)
(let result (form-invoke counter :increment))
(if (eq result 11)
  (io/putf "  PASS: Affordance invoked on int value\n")
  (io/putf "  FAIL: Expected 11\n"))

(io/putf "Test 2: Invoke affordance with additional args\n")
(form-define :Calculator :int)
(form-add-affordance :Calculator :add (lambda [x y] (+ x y)))
(let calc 5)
(let result2 (form-invoke calc :add 3))
(if (eq result2 8)
  (io/putf "  PASS: Additional args passed correctly\n")
  (io/putf "  FAIL: Expected 8\n"))

(io/putf "Test 3: Multiple affordances on same form\n")
(form-define :Math :int)
(form-add-affordance :Math :double (lambda [x] (* x 2)))
(form-add-affordance :Math :triple (lambda [x] (* x 3)))
(let val3 5)
(let r3a (form-invoke val3 :double))
(let r3b (form-invoke val3 :triple))
(if (and (eq r3a 10) (eq r3b 15))
  (io/putf "  PASS: Multiple affordances work\n")
  (io/putf "  FAIL: Expected 10 and 15\n"))

(io/putf "Test 4: Affordance on real value\n")
(form-define :Temperature :real)
(form-add-affordance :Temperature :add-ten (lambda [x] (+ x 10.0)))
(let temp 5.5)
(form-invoke temp :add-ten)
(io/putf "  PASS: Affordance on real invoked\n")

(io/putf "Test 5: Affordance with closure\n")
(let base 100)
(form-define :Offsetter :int)
(form-add-affordance :Offsetter :add-base (lambda [x] (+ x base)))
(let val5 50)
(let result5 (form-invoke val5 :add-base))
(if (eq result5 150)
  (io/putf "  PASS: Closure captured in affordance\n")
  (io/putf "  FAIL: Expected 150\n"))

(io/putf "Test 6: Chain affordance invocations\n")
(form-define :Chainable :int)
(form-add-affordance :Chainable :inc (lambda [x] (+ x 1)))
(form-add-affordance :Chainable :double (lambda [x] (* x 2)))
(let v1 10)
(let v2 (form-invoke v1 :inc))
(let v3 (form-invoke v2 :double))
(if (eq v3 22)
  (io/putf "  PASS: Chained invocations work\n")
  (io/putf "  FAIL: Expected 22\n"))

(io/putf "Test 7: Affordance persists across invocations\n")
(form-define :Persistent :int)
(form-add-affordance :Persistent :add-one (lambda [x] (+ x 1)))
(let v7a 3)
(let v7b 4)
(let a (form-invoke v7a :add-one))
(let b (form-invoke v7b :add-one))
(if (and (eq a 4) (eq b 5))
  (io/putf "  PASS: Affordance persists correctly\n")
  (io/putf "  FAIL: Expected 4 and 5\n"))

(io/putf "Test 8: Complex logic in affordance\n")
(form-define :Validator :int)
(form-add-affordance :Validator :is-positive (lambda [x] (if (gt x 0) 1 0)))
(let v8 10)
(let r8 (form-invoke v8 :is-positive))
(if (eq r8 1)
  (io/putf "  PASS: Complex logic works\n")
  (io/putf "  FAIL: Expected 1\n"))

(io/putf "\n=== All Affordance Invocation Tests Complete ===\n")
